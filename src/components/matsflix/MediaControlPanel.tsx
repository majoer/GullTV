import { useState } from "react";
import { MediaButtonComponent } from "../ui/MediaButtonComponent";
import { PopupComponent } from "../ui/PopupComponent";
import { SliderComponent } from "../ui/SliderComponent";

export interface MediaControlStatus {
  position: number;
}

export interface MediaControlPanelProps {
  disabled: boolean;
  time: number;
  length: number;
  volume: number;
  muted: boolean;
  title: string;
  state?: "playing" | "stopped" | "paused";
  audioTracks?: { label: string; id: string }[];
  subtitles?: { label: string; id: string }[];
  onSetVolume: (volume: number) => void;
  onNext: () => void;
  onPrev: () => void;
  onPlay: () => void;
  onPause: () => void;
  onSeek: (value: number) => void;
  onSetSubtitle: (language: string) => void;
  onSetAudioTrack: (track: string) => void;
}

export const MediaControlPanel = (props: MediaControlPanelProps) => {
  const {
    time,
    length,
    title,
    disabled,
    state,
    volume,
    muted,
    subtitles = [],
    audioTracks = [],
  } = props;
  const [settingsOpen, setSettingsOpen] = useState(false);
  const [volumeOpen, setVolumeOpen] = useState(false);

  return (
    <footer className="fixed bottom-0 left-0 right-0 w-full h-32 bg-black flex flex-col justify-between">
      <div className="mx-3 text-center">
        <SliderComponent
          orientation="horizontal"
          style="white"
          value={time}
          max={length}
          onChange={async (v) => props.onSeek(v)}
          formatTitle={(seconds) => {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            return [
              hrs.toString().padStart(2, "0"),
              mins.toString().padStart(2, "0"),
              secs.toString().padStart(2, "0"),
            ].join(":");
          }}
        />
        <div className="text-nowrap overflow-clip" title={title}>
          {title}
        </div>
      </div>

      <div className="flex flex-nowrap w-full justify-between">
        <MediaButtonComponent
          disabled={disabled}
          aria-label="captions"
          className="relative"
          onClick={() => {
            setSettingsOpen(!settingsOpen);
          }}
        >
          <svg
            viewBox="-3 -3 30 30"
            fill="inherit"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M9.81438 2.82304C9.89603 2.48676 10.1972 2.25 10.5432 2.25H13.4568C13.8028 2.25 14.104 2.48676 14.1856 2.82304L14.6445 4.71318C14.8619 4.79207 15.0746 4.88038 15.2824 4.97763L16.9574 3.95711C17.2529 3.77706 17.6332 3.82257 17.8779 4.06726L19.9328 6.12213C20.1775 6.36682 20.223 6.74716 20.0429 7.04268L19.0224 8.71767C19.1197 8.9254 19.208 9.13818 19.2869 9.3555L21.177 9.81442C21.5132 9.89607 21.75 10.1972 21.75 10.5432V13.4569C21.75 13.8029 21.5132 14.104 21.177 14.1857L19.2869 14.6446C19.208 14.8619 19.1197 15.0747 19.0224 15.2824L20.0429 16.9574C20.223 17.2529 20.1774 17.6332 19.9328 17.8779L17.8779 19.9328C17.6332 20.1775 17.2528 20.223 16.9573 20.043L15.2824 19.0225C15.0746 19.1197 14.8619 19.208 14.6445 19.2869L14.1856 21.177C14.104 21.5132 13.8029 21.75 13.4568 21.75H10.5432C10.1971 21.75 9.89601 21.5132 9.81436 21.177L9.35545 19.2869C9.13813 19.208 8.92536 19.1197 8.71764 19.0225L7.0427 20.043C6.74718 20.223 6.36683 20.1775 6.12214 19.9328L4.06725 17.8779C3.82256 17.6332 3.77705 17.2529 3.9571 16.9574L4.97759 15.2824C4.88035 15.0747 4.79203 14.8619 4.71314 14.6446L2.82304 14.1857C2.48676 14.104 2.25 13.8029 2.25 13.4569V10.5432C2.25 10.1972 2.48676 9.89607 2.82304 9.81442L4.71314 9.3555C4.79203 9.13818 4.88035 8.92541 4.97759 8.71769L3.95706 7.04268C3.77701 6.74716 3.82252 6.36682 4.06722 6.12212L6.12208 4.06726C6.36677 3.82257 6.74712 3.77706 7.04264 3.95711L8.71764 4.97763C8.92536 4.88039 9.13813 4.79207 9.35545 4.71318L9.81438 2.82304ZM12 10.25C11.0335 10.25 10.25 11.0335 10.25 12C10.25 12.9665 11.0335 13.75 12 13.75C12.9665 13.75 13.75 12.9665 13.75 12C13.75 11.0335 12.9665 10.25 12 10.25Z"
              fill="inherit"
            />
          </svg>
          <PopupComponent open={settingsOpen}>
            <div className="grid grid-cols-2 gap-2 w-64 text-left">
              <label htmlFor="subtitle">Subtitle: </label>
              <select
                id="subtitle"
                disabled={subtitles.length === 0}
                onChange={async (e) => {
                  props.onSetSubtitle(e.currentTarget.value);
                }}
              >
                {subtitles.map((s) => (
                  <option value={s.id}>{s.label}</option>
                ))}
              </select>

              <label htmlFor="audio">Audio: </label>
              <select
                id="audio"
                disabled={audioTracks.length === 0}
                onChange={async (e) => {
                  props.onSetAudioTrack(e.target.value);
                }}
              >
                {audioTracks.map((s) => (
                  <option value={s.id}>{s.label}</option>
                ))}
              </select>
            </div>
          </PopupComponent>
        </MediaButtonComponent>

        <MediaButtonComponent
          disabled={disabled}
          aria-label="previous"
          onClick={async () => {
            props.onPrev();
          }}
        >
          <svg
            viewBox="0 0 24 24"
            fill="inherit"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M4 6.25C3.58579 6.25 3.25 6.58579 3.25 7V17C3.25 17.4142 3.58579 17.75 4 17.75C4.41421 17.75 4.75 17.4142 4.75 17V7C4.75 6.58579 4.41421 6.25 4 6.25ZM13.75 9.31371L11.9828 10.576C11.5229 10.9045 11.25 11.4348 11.25 12C11.25 12.5652 11.5229 13.0955 11.9828 13.424L13.75 14.6863V17C13.75 17.2809 13.593 17.5383 13.3432 17.6669C13.0934 17.7954 12.7927 17.7736 12.5641 17.6103L5.56407 12.6103C5.36697 12.4695 5.25 12.2422 5.25 12C5.25 11.7578 5.36697 11.5305 5.56407 11.3897L12.5641 6.3897C12.7927 6.22641 13.0934 6.20457 13.3432 6.33313C13.593 6.46168 13.75 6.71906 13.75 7V9.31371ZM19.5641 6.3897C19.7927 6.22641 20.0934 6.20457 20.3432 6.33313C20.593 6.46168 20.75 6.71906 20.75 7V17C20.75 17.2809 20.593 17.5383 20.3432 17.6669C20.0934 17.7954 19.7927 17.7736 19.5641 17.6103L12.5641 12.6103C12.367 12.4695 12.25 12.2422 12.25 12C12.25 11.7578 12.367 11.5305 12.5641 11.3897L19.5641 6.3897Z"
              fill="inherit"
            />
          </svg>
        </MediaButtonComponent>
        {state === "playing" ? (
          <MediaButtonComponent
            aria-label="pause"
            disabled={disabled}
            onClick={async () => {
              props.onPause();
            }}
          >
            <svg
              viewBox="0 0 24 24"
              fill="inherit"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M7 6.25C6.58579 6.25 6.25 6.58579 6.25 7V17C6.25 17.4142 6.58579 17.75 7 17.75H10C10.4142 17.75 10.75 17.4142 10.75 17V7C10.75 6.58579 10.4142 6.25 10 6.25H7ZM14 6.25C13.5858 6.25 13.25 6.58579 13.25 7V17C13.25 17.4142 13.5858 17.75 14 17.75H17C17.4142 17.75 17.75 17.4142 17.75 17V7C17.75 6.58579 17.4142 6.25 17 6.25H14Z"
                fill="inherit"
              />
            </svg>
          </MediaButtonComponent>
        ) : (
          <MediaButtonComponent
            aria-label="Play"
            disabled={disabled}
            onClick={async () => {
              props.onPlay();
            }}
          >
            <svg
              viewBox="0 0 24 24"
              fill="inherit"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M8.61965 6.3536C8.84869 6.21883 9.13193 6.21533 9.36423 6.34438L18.3642 11.3444C18.6023 11.4767 18.75 11.7276 18.75 12C18.75 12.2724 18.6023 12.5233 18.3642 12.6556L9.36423 17.6556C9.13193 17.7847 8.84869 17.7812 8.61965 17.6464C8.39062 17.5116 8.25 17.2657 8.25 17V7C8.25 6.73426 8.39062 6.48836 8.61965 6.3536Z"
                fill="inherit"
              />
            </svg>
          </MediaButtonComponent>
        )}
        <MediaButtonComponent
          disabled={disabled}
          aria-label="next"
          onClick={async () => {
            props.onNext();
          }}
        >
          <svg
            viewBox="0 0 24 24"
            fill="inherit"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M20 6.25C20.4142 6.25 20.75 6.58579 20.75 7V17C20.75 17.4142 20.4142 17.75 20 17.75C19.5858 17.75 19.25 17.4142 19.25 17V7C19.25 6.58579 19.5858 6.25 20 6.25ZM10.3547 14.6115C10.289 14.6585 10.25 14.7342 10.25 14.815V17C10.25 17.2809 10.407 17.5383 10.6568 17.6669C10.9066 17.7954 11.2073 17.7736 11.4359 17.6103L18.4359 12.6103C18.633 12.4695 18.75 12.2422 18.75 12C18.75 11.7578 18.633 11.5305 18.4359 11.3897L11.4359 6.3897C11.2073 6.22641 10.9066 6.20457 10.6568 6.33313C10.407 6.46168 10.25 6.71906 10.25 7V9.18506C10.25 9.2658 10.289 9.34156 10.3547 9.38849L12.0172 10.576C12.4771 10.9045 12.75 11.4348 12.75 12C12.75 12.5652 12.4771 13.0955 12.0172 13.424L10.3547 14.6115ZM4.43593 6.3897C4.20732 6.22641 3.90662 6.20457 3.65681 6.33313C3.40701 6.46168 3.25 6.71906 3.25 7V17C3.25 17.2809 3.40701 17.5383 3.65681 17.6669C3.90662 17.7954 4.20732 17.7736 4.43593 17.6103L11.4359 12.6103C11.633 12.4695 11.75 12.2422 11.75 12C11.75 11.7578 11.633 11.5305 11.4359 11.3897L4.43593 6.3897Z"
              fill="inherit"
            />
          </svg>
        </MediaButtonComponent>
        <MediaButtonComponent
          disabled={disabled}
          className="relative"
          aria-label="volume"
          onClick={() => setVolumeOpen(!volumeOpen)}
        >
          <VolumeIcon muted={muted} volume={volume} />
          <PopupComponent open={volumeOpen}>
            <div className="h-34 w-6 flex justify-center">
              <SliderComponent
                orientation="vertical"
                style="black"
                value={volume}
                max={100}
                onChange={async (v) => {
                  props.onSetVolume(v);
                }}
              />
            </div>
          </PopupComponent>
        </MediaButtonComponent>
      </div>
    </footer>
  );
};

const VolumeIcon = (props: { muted: boolean; volume: number }) => {
  const { muted, volume } = props;
  if (muted) {
    return (
      <svg
        viewBox="0 0 24 24"
        fill="inherit"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M20.5303 4.53033C20.8232 4.23744 20.8232 3.76256 20.5303 3.46967C20.2374 3.17678 19.7626 3.17678 19.4697 3.46967L3.46967 19.4697C3.17678 19.7626 3.17678 20.2374 3.46967 20.5303C3.76256 20.8232 4.23744 20.8232 4.53033 20.5303L20.5303 4.53033ZM12.75 5C12.75 4.7117 12.5847 4.44891 12.3249 4.32402C12.065 4.19913 11.7566 4.23425 11.5315 4.41435L6.73691 8.25H3C2.58579 8.25 2.25 8.58579 2.25 9V15C2.25 15.4142 2.58579 15.75 3 15.75H5.11395C5.52816 15.75 5.86395 15.4142 5.86395 15C5.86395 14.5858 5.52816 14.25 5.11395 14.25H3.75V9.75H7C7.1703 9.75 7.33554 9.69204 7.46852 9.58565L11.25 6.56047V8.10937C11.25 8.52359 11.5858 8.85937 12 8.85937C12.4142 8.85937 12.75 8.52359 12.75 8.10937V5ZM12.7498 15.8867C12.7498 15.4725 12.414 15.1367 11.9998 15.1367C11.5856 15.1367 11.2498 15.4725 11.2498 15.8867V17.4395L10.7405 17.0321C10.417 16.7733 9.94508 16.8258 9.68632 17.1492C9.42756 17.4727 9.48 17.9447 9.80345 18.2034L11.5312 19.5857C11.7564 19.7658 12.0648 19.8009 12.3247 19.676C12.5845 19.5511 12.7498 19.2883 12.7498 19V15.8867ZM19.6556 7.20679C20.0236 7.01659 20.4761 7.1607 20.6663 7.52867C21.3589 8.86876 21.7498 10.3898 21.7498 11.9999C21.7498 14.6931 20.6568 17.1325 18.892 18.8963C18.599 19.1891 18.1241 19.1889 17.8313 18.896C17.5385 18.603 17.5387 18.1281 17.8316 17.8353C19.3265 16.3414 20.2498 14.2792 20.2498 11.9999C20.2498 10.635 19.919 9.34963 19.3337 8.21743C19.1435 7.84946 19.2877 7.39698 19.6556 7.20679ZM18.4294 9.93919C18.3031 9.54472 17.8809 9.32736 17.4864 9.45371C17.0919 9.58007 16.8746 10.0023 17.0009 10.3967C17.1625 10.9012 17.25 11.4397 17.25 12.0001C17.25 13.4509 16.6625 14.7631 15.7106 15.7141C15.4176 16.0068 15.4174 16.4817 15.7102 16.7747C16.0029 17.0678 16.4778 17.068 16.7708 16.7752C17.9928 15.5544 18.75 13.8649 18.75 12.0001C18.75 11.2825 18.6378 10.5898 18.4294 9.93919ZM15.4221 11.8604C15.83 11.9326 16.1021 12.3218 16.0299 12.7296C15.8779 13.5881 15.4633 14.3546 14.8738 14.9435C14.5808 15.2363 14.1059 15.2361 13.8132 14.943C13.5204 14.65 13.5206 14.1751 13.8137 13.8824C14.1921 13.5043 14.4561 13.0145 14.5529 12.4681C14.6251 12.0602 15.0143 11.7881 15.4221 11.8604Z"
          fill="inherit"
        />
      </svg>
    );
  }

  if (volume === 0) {
    return (
      <svg
        viewBox="0 0 24 24"
        fill="inherit"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M15.8249 4.32403C16.0847 4.44892 16.25 4.7117 16.25 5.00001V19C16.25 19.2883 16.0847 19.5511 15.8249 19.676C15.565 19.8009 15.2566 19.7658 15.0315 19.5857L10.2369 15.75H6.5C6.08579 15.75 5.75 15.4142 5.75 15V9.00001C5.75 8.58579 6.08579 8.25001 6.5 8.25001H10.2369L15.0315 4.41436C15.2566 4.23425 15.565 4.19914 15.8249 4.32403ZM14.75 6.56048L10.9685 9.58566C10.8355 9.69205 10.6703 9.75001 10.5 9.75001H7.25V14.25H10.5C10.6703 14.25 10.8355 14.308 10.9685 14.4144L14.75 17.4395V6.56048Z"
          fill="inherit"
        />
      </svg>
    );
  }

  if (volume < 30) {
    return (
      <svg
        viewBox="0 0 24 24"
        fill="inherit"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M12.75 5C12.75 4.7117 12.5847 4.44891 12.3249 4.32402C12.065 4.19913 11.7566 4.23425 11.5315 4.41435L6.73691 8.25H3C2.58579 8.25 2.25 8.58579 2.25 9V15C2.25 15.4142 2.58579 15.75 3 15.75H6.73691L11.5315 19.5857C11.7566 19.7658 12.065 19.8009 12.3249 19.676C12.5847 19.5511 12.75 19.2883 12.75 19V5ZM7.46852 9.58565L11.25 6.56047V17.4395L7.46852 14.4143C7.33554 14.308 7.1703 14.25 7 14.25H3.75V9.75H7C7.1703 9.75 7.33554 9.69204 7.46852 9.58565ZM14.8738 9.05683C14.5808 8.76407 14.1059 8.76428 13.8132 9.0573C13.5204 9.35032 13.5206 9.8252 13.8137 10.118C14.2964 10.6003 14.5938 11.2648 14.5938 12.0001C14.5938 12.7354 14.2964 13.3999 13.8137 13.8823C13.5206 14.175 13.5204 14.6499 13.8132 14.9429C14.1059 15.2359 14.5808 15.2361 14.8738 14.9434C15.6267 14.1912 16.0938 13.1495 16.0938 12.0001C16.0938 10.8507 15.6267 9.80902 14.8738 9.05683Z"
          fill="inherit"
        />
      </svg>
    );
  }
  if (volume < 70) {
    return (
      <svg
        viewBox="0 0 24 24"
        fill="inherit"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M12.3249 4.32402C12.5847 4.44891 12.75 4.7117 12.75 5V19C12.75 19.2883 12.5847 19.5511 12.3249 19.676C12.065 19.8009 11.7566 19.7658 11.5315 19.5857L6.73691 15.75H3C2.58579 15.75 2.25 15.4142 2.25 15V9C2.25 8.58579 2.58579 8.25 3 8.25H6.73691L11.5315 4.41435C11.7566 4.23425 12.065 4.19913 12.3249 4.32402ZM11.25 6.56047L7.46852 9.58565C7.33554 9.69204 7.1703 9.75 7 9.75H3.75V14.25H7C7.1703 14.25 7.33554 14.308 7.46852 14.4143L11.25 17.4395V6.56047ZM15.7102 7.22528C16.0029 6.93226 16.4778 6.93204 16.7708 7.2248C17.9928 8.44566 18.75 10.1351 18.75 12C18.75 13.8648 17.9928 15.5543 16.7708 16.7751C16.4778 17.0679 16.0029 17.0677 15.7102 16.7746C15.4174 16.4816 15.4176 16.0067 15.7106 15.714C16.6625 14.763 17.25 13.4508 17.25 12C17.25 10.5491 16.6625 9.23696 15.7106 8.28594C15.4176 7.99318 15.4174 7.51831 15.7102 7.22528ZM14.8738 9.05683C14.5808 8.76407 14.1059 8.76428 13.8132 9.0573C13.5204 9.35032 13.5206 9.8252 13.8137 10.118C14.2964 10.6003 14.5938 11.2648 14.5938 12.0001C14.5938 12.7354 14.2964 13.3999 13.8137 13.8823C13.5206 14.175 13.5204 14.6499 13.8132 14.9429C14.1059 15.2359 14.5808 15.2361 14.8738 14.9434C15.6267 14.1912 16.0938 13.1495 16.0938 12.0001C16.0938 10.8507 15.6267 9.80902 14.8738 9.05683Z"
          fill="inherit"
        />
      </svg>
    );
  }
  return (
    <svg viewBox="0 0 24 24" fill="inherit" xmlns="http://www.w3.org/2000/svg">
      <path
        fill-rule="evenodd"
        clip-rule="evenodd"
        d="M12.75 5C12.75 4.7117 12.5847 4.44891 12.3249 4.32402C12.065 4.19913 11.7566 4.23425 11.5315 4.41435L6.73691 8.25H3C2.58579 8.25 2.25 8.58579 2.25 9V15C2.25 15.4142 2.58579 15.75 3 15.75H6.73691L11.5315 19.5857C11.7566 19.7658 12.065 19.8009 12.3249 19.676C12.5847 19.5511 12.75 19.2883 12.75 19V5ZM7.46852 9.58565L11.25 6.56047V17.4395L7.46852 14.4143C7.33554 14.308 7.1703 14.25 7 14.25H3.75V9.75H7C7.1703 9.75 7.33554 9.69204 7.46852 9.58565ZM18.892 5.10354C18.599 4.81074 18.1241 4.81088 17.8313 5.10386C17.5385 5.39685 17.5387 5.87172 17.8316 6.16452C19.3265 7.65845 20.2498 9.72066 20.2498 11.9999C20.2498 14.2792 19.3265 16.3414 17.8316 17.8354C17.5387 18.1282 17.5385 18.603 17.8313 18.896C18.1241 19.189 18.599 19.1892 18.892 18.8964C20.6568 17.1326 21.7498 14.6932 21.7498 11.9999C21.7498 9.30669 20.6568 6.86729 18.892 5.10354ZM15.7102 7.22528C16.0029 6.93226 16.4778 6.93204 16.7708 7.2248C17.9928 8.44566 18.75 10.1351 18.75 12C18.75 13.8648 17.9928 15.5543 16.7708 16.7751C16.4778 17.0679 16.0029 17.0677 15.7102 16.7746C15.4174 16.4816 15.4176 16.0067 15.7106 15.714C16.6625 14.763 17.25 13.4508 17.25 12C17.25 10.5491 16.6625 9.23696 15.7106 8.28594C15.4176 7.99318 15.4174 7.51831 15.7102 7.22528ZM14.8738 9.05684C14.5808 8.76407 14.1059 8.76428 13.8132 9.05731C13.5204 9.35033 13.5206 9.8252 13.8137 10.118C14.2964 10.6003 14.5938 11.2648 14.5938 12.0001C14.5938 12.7354 14.2964 13.3999 13.8137 13.8823C13.5206 14.175 13.5204 14.6499 13.8132 14.9429C14.1059 15.2359 14.5808 15.2362 14.8738 14.9434C15.6267 14.1912 16.0938 13.1495 16.0938 12.0001C16.0938 10.8507 15.6267 9.80903 14.8738 9.05684Z"
        fill="inherit"
      />
    </svg>
  );
};
